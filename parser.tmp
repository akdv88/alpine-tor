#!/bin/sh
http="http:\/\/.*"
https="https:\/\/.*"
dir="/tmp"
inlist="$dir/curl-list"
outlist="$dir/out-list"
pac="$dir/tor-proxy.pac"

curl http://api.antizapret.info/all.php \
| sed 's/^[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9];//g; s/^;//g; s/;.*$//g; s/^.*http:\/\//http:\/\//g; s/^.*https:\/\//https:\/\//g; /^$/d' \
| tr '[:upper:]' '[:lower:]' > $inlist

# http
grep -E "^http:" $inlist \
        | sed 's/^http:\/\/www[0-9]*\.//g; s/^http:\/\///g; s/\/.*//g' > $outlist \
        && sed -i '/^http:/d' $inlist

# https
grep -E "^https:" $inlist \
        | sed 's/^https:\/\/www[0-9]*\.//g; s/^https:\/\///g; s/\/.*//g' >> $outlist \
        && sed -i '/^https:/d' $inlist

# asterisk
grep -E "^\*" $inlist \
        | sed 's/^\*\.//g' >> $outlist \
        && sed -i '/^\*/d' $inlist

# comma
grep -E ',' $inlist | tr "," "\n" \
        | sed 's/^newcamd525:\/\///g; s/:[0-9]*$//g' >> $outlist \
        && sed -i '/,/d' $inlist

# simple
sed 's/^www[0-9]*\.//g' $inlist >> $outlist \
        && rm $inlist

#tor-proxy.pac
echo -e 'function FindProxyForURL(url, host) {\n\thost = host.toLowerCase();' > $pac \
        && sort -u out-list | sort -d \
        | while read line
          do
                if (echo $line | grep -Eq "[а-я]"); then
                        echo -e "\tif (dnsDomainIs(host, \"$(echo $line | idn)\")) return \"SOCKS 127.0.0.1:9050\";" >> $pac
                else
                        echo -e "\tif (dnsDomainIs(host, \"$line\")) return \"SOCKS 127.0.0.1:9050\";" >> $pac
                fi
          done \
        && echo "}" >> $pac \
        && rm $outlist
